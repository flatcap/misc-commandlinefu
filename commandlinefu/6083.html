<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN'
    'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
  <head>
    <link rel='stylesheet' href='style.css' type='text/css' />
    <title>
      command line fu
    </title>
  </head>
  <body>
    <div class='terminal'>
      <div class='author'>
        dopeman
      </div>
      <div class='summary'>
        List open files that have no links to them on the filesystem
      </div>
      <div class='command'>
        lsof +L1
      </div>
      <div class='sample'>
        <pre>
COMMAND     PID   USER   FD   TYPE DEVICE    SIZE NLINK   NODE NAME
a-proc    23521   root    3u   REG    8,1 5595979     0 353398 /some/logfile (deleted)
</pre>
      </div>
      <div class='desc'>
        <p>
          I have come across a situation in the past where someone has unlinked a file by running an 'rm' command against it while it was still being written to by a running process.
        </p>
        <p>
          The problem manifested itself when a 'df' command showed a filesystem at 100%, but this did not match the total value of a 'du -sk *'.
        </p>
        <p>
          When this happens, the process continues to write to the file but you can no longer see the file on the filesystem. Stopping and starting the process will, more often than not, get rid of the unlinked file, however this is not always possible on a live server.
        </p>
        <p>
          When you are in this situation you can use the 'lsof' command above to get the PID of the process that owns the file (in the sample output this is 23521).
        </p>
        <p>
          Run the following command to see a sym-link to the file (marked as deleted):
        </p><code>cd /proc/23521/fd &amp;&amp; ls -l</code>
        <p>
          Truncate the sym-link to regain your disk space:
        </p><code>&gt; /proc/23521/fd/3</code>
        <p>
          I should point out that this is pretty brutal and *could* potentially destabilise your system depending on what process the file belongs to that you are truncating.
        </p>
      </div>
    </div>
    <div class='comment'>
      <div class='author'>
        zlemini
      </div>
      <div class='text'>
        <p>
          I normally use "lsof | grep deleted" for this then restart the process with the file open to resolve these types of issues.
        </p>
        <p>
          Files with a link count less than 1 can also mean someone is trying to hide something...
        </p>
      </div>
    </div>
    <div class='comment'>
      <div class='author'>
        inof
      </div>
      <div class='text'>
        <p>
          You can restrict the output to a certain file system, e.g. /var, like this:
        </p><code>lsof +aL1 /var</code>
      </div>
    </div>
  </body>
</html>
